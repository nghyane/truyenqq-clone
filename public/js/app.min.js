const encrypt=async(e,t)=>{let a=new TextEncoder,l=await crypto.subtle.importKey("raw",a.encode(t),"AES-GCM",!0,["encrypt"]),r=crypto.getRandomValues(new Uint8Array(12)),n=a.encode(e),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},l,n);return btoa(JSON.stringify({iv:btoa(String.fromCharCode.apply(null,r)),encryptedData:btoa(String.fromCharCode.apply(null,new Uint8Array(o)))}))};window.App=(()=>{let e=["location","hostname"],t=async()=>{null===localStorage.getItem(window.VARIABLES.UUID_HASH)&&localStorage.setItem(window.VARIABLES.UUID_HASH,window.crypto.randomUUID());let t=await encrypt(JSON.stringify({time:Date.now(),platform:window.navigator.platform,screen:`${window.screen.width}x${window.screen.height}`,uuidHash:localStorage.getItem(window.VARIABLES.UUID_HASH)}),e.join(""));return sessionStorage.setItem(window.VARIABLES.VISITOR_TOKEN,t.toString()),t.toString()},a=async()=>{let e=document.querySelector("#search-chapter"),t=document.querySelector("#load-more-chapters"),a=document.querySelectorAll(".lazy"),l=document.querySelector(".carousel-viewport"),r=document.querySelector(".header-input");if(e){let c=document.querySelectorAll("#chapter-list li");e.addEventListener("keyup",e=>{c.forEach(t=>{let a=t.querySelector("a").innerText.toLowerCase();t.classList.toggle("hidden",!a.includes(e.target.value.toLowerCase()))})})}t&&t.addEventListener("click",e=>{e.preventDefault();let a=document.querySelectorAll("#chapter-list li.hidden");a.forEach(e=>e.classList.remove("hidden")),t.remove()}),a.length>0&&o(),l&&setTimeout(n,1e3),r&&i();let s=document.querySelector("#back-to-top-button");window.addEventListener("scroll",e=>{window.scrollY>100?s.classList.remove("opacity-0"):s.classList.add("opacity-0")}),s?.addEventListener("click",e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"auto"})}),setTimeout(()=>{d()},500)},l=()=>{let e=localStorage.getItem(window.VARIABLES.HISTORIES)?JSON.parse(localStorage.getItem(window.VARIABLES.HISTORIES)):[],t=window.__INITIAL_STATE__?.mangaId;if(!t)return;let a=e.findIndex(e=>e.mangaId===t);-1!==a&&e.splice(a,1),e.unshift(window.__INITIAL_STATE__),e.length>100&&e.pop(),localStorage.setItem(window.VARIABLES.HISTORIES,JSON.stringify(e))},r=async()=>{setTimeout(()=>{l()},1e3),document.querySelector("nav").classList.remove("lg:sticky");let e=document.querySelector("#chapter-nav"),t=document.querySelector("#nav-placeholder"),a=document.querySelectorAll(".next-chapter"),r=document.querySelectorAll(".prev-chapter"),n=e.offsetTop,o=window.scrollY,i=document.querySelector("#chapters"),c=e=>{let t=i.querySelector(`option[value="${e.target.value}"]`);t&&(window.location.href=`/read?id=${t.value}`)};a?.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();let t=i.querySelector(`option[value="${window.__INITIAL_STATE__.chapterId}"]`).previousElementSibling;t?c({target:{value:t.value}}):alert("No more chapter")})}),r?.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();let t=i.querySelector(`option[value="${window.__INITIAL_STATE__.chapterId}"]`).nextElementSibling;t&&c({target:{value:t.value}})})}),fetch(`/api/v1/chapters?id=${window.__INITIAL_STATE__.mangaId}`).then(e=>e.text()).then(e=>{e=e.replace(`value="${window.__INITIAL_STATE__.chapterId}"`,`value="${window.__INITIAL_STATE__.chapterId}" selected`),i.innerHTML=e}),i.addEventListener("change",e=>{e.target.value!==window.__INITIAL_STATE__.chapterId&&(window.location.href=`/read?id=${e.target.value}`)}),window.addEventListener("scroll",a=>{window.innerWidth>=768&&window.scrollY>=n||window.innerWidth<768&&window.scrollY>=n+e.offsetHeight?(t.classList.remove("hidden"),e.style="position: fixed; top: 0; left: 0; right: 0; z-index: 9999;",window.innerWidth<768&&(window.scrollY>o?e.style.opacity="0":e.style.opacity="1")):(t.classList.add("hidden"),e.style=""),o=window.scrollY});let s=window.location.hostname.includes("localhost")?"cloudflare.com":window.location.hostname,d=await fetch(`https://${s}/cdn-cgi/trace`),u=await d.text();if(!u.includes("loc=JP")){let I=document.querySelectorAll("#viewer .page-img");await I.forEach((e,t)=>{e.setAttribute("data-src",`https://picsum.photos/seed/${window.__INITIAL_STATE__.mangaId}-${window.__INITIAL_STATE__.chapterId}-${t}/536/354/`)})}async function p(e){let t=new Image;return t.src=e,new Promise((e,a)=>{t.onload=()=>e(t),t.onerror=a})}async function h(e,t){let a=e.map(async e=>{if(e.isIntersecting){let a=e.target;t.unobserve(a);let l=a.getAttribute("data-src"),r=await p(l);r.classList.add("w-full","h-full"),a.innerHTML=r.outerHTML}});await Promise.all(a)}let y=new IntersectionObserver(h,{root:null,rootMargin:"800px",threshold:0});document.querySelector("#viewer").addEventListener("contextmenu",e=>{e.preventDefault()});let m=document.querySelectorAll("#viewer .page-img");m.forEach(e=>{y.observe(e)}),setTimeout(()=>{fetch(`/view-count?mangaId=${window.__INITIAL_STATE__.mangaId}&chapterId=${window.__INITIAL_STATE__.chapterId}`)},2e4)},n=async()=>{let e=document.querySelector(".carousel-viewport"),t=await import("https://cdn.jsdelivr.net/npm/embla-carousel@8.0.0-rc19/+esm"),a=t.default(e,{loop:!0,slidesToScroll:"auto",containScroll:"trimSnaps",align:"start"}),l=document.querySelector(".carousel-button--prev"),r=document.querySelector(".carousel-button--next");l.addEventListener("click",a.scrollPrev,!1),r.addEventListener("click",a.scrollNext,!1)},o=async()=>{let e=await import("https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.5/+esm");window.lazyLoadOptions={threshold:0},window.addEventListener("LazyLoad::Initialized",function(e){window.lazyLoadInstance=e.detail.instance},!1),new e.default({elements_selector:".lazy",callback_enter:function(e){e.classList.remove("opacity-0")}})},i=async()=>{let e=document.querySelector(".header-input"),t=document.querySelector(".search-results");e.addEventListener("keyup",async a=>{let l=await fetch(`/search-ajax?keyword=${a.target.value}`,{headers:{"Content-Type":"application/json"}});t.style.display="block",document.addEventListener("click",a=>{t.contains(a.target)||e.contains(a.target)?t.style.display="block":t.style.display="none"}),t.innerHTML=await l.text()})},c=async(e,a)=>{sessionStorage.setItem(window.VARIABLES.CACHE_ID,btoa(Date.now()+localStorage.getItem(window.VARIABLES.UUID_HASH)));let l=window.location.pathname.includes("/manga")?"manga":"chapter";fetch("/api/v1/user/bookmark",{headers:{token:await t()},body:JSON.stringify({template:l,id:a}),method:"POST"}).then(e=>e.text()).then(t=>{e.outerHTML=t})},s=async(e,a)=>{sessionStorage.setItem(window.VARIABLES.CACHE_ID,btoa(Date.now()+localStorage.getItem(window.VARIABLES.UUID_HASH)));let l=window.location.pathname.includes("/manga")?"manga":"chapter";fetch("/api/v1/user/bookmark",{headers:{token:await t()},body:JSON.stringify({template:l,id:a}),method:"DELETE"}).then(e=>e.text()).then(t=>{e.outerHTML=t})},d=async()=>{let e=window?.__INITIAL_STATE__?.mangaId,a=sessionStorage.getItem(window.VARIABLES.CACHE_ID),l=window.location.pathname.includes("/manga")?"manga":"chapter";e&&localStorage.getItem(window.VARIABLES.UUID_HASH)&&(a||sessionStorage.setItem(window.VARIABLES.CACHE_ID,btoa(Date.now()+localStorage.getItem(window.VARIABLES.UUID_HASH))),fetch(`/api/v1/user/bookmark?template=${l}&id=${e}&cacheId=${a}`,{method:"GET",headers:{token:await t()}}).then(e=>e.text()).then(e=>{document.querySelector("#bookmark").outerHTML=e}))},u=()=>{let e=document.querySelector("#search-form");e.classList.toggle("flex"),e.classList.toggle("hidden")},I=()=>{let e=document.querySelectorAll(".menu-hidden");e.forEach(e=>{e.classList.toggle("!block");let t=e.querySelector(".hidden-menu");t&&e.firstElementChild.addEventListener("click",e=>{e.preventDefault(),t.classList.toggle("!block")})})},p=e=>{let t=document.querySelector("#toast");t.classList.contains("hidden")&&(t.querySelector("#toast-message").innerHTML=e,t.classList.remove("opacity-0"),t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},4e3),setTimeout(()=>{t.classList.add("opacity-0")},2900))};return{Initialized:a,ReadingInit:r,Carousel:n,addToBookmark:c,removeFromBookmark:s,toggleSearch:u,toggleMenu:I,showToaster:p,getVisitorToken:t,LazyLoad:o}})(),window.addEventListener("DOMContentLoaded",()=>{window.App.Initialized(),window.location.pathname.includes("/read")&&window.App.ReadingInit()});